<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoolRide V9.7: Markers & Toggles</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@500&family=Noto+Sans+Tamil:wght@500&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        #panel {
            position: absolute; top: 20px; left: 20px; width: 360px;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px);
            padding: 24px; border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            z-index: 1000; border: 1px solid rgba(0,0,0,0.05);
            display: flex; flex-direction: column; gap: 12px;
            max-height: 90vh; overflow-y: auto; transition: all 0.3s ease;
        }

        datalist { display: none; }
        
        /* HEADER */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .close-btn { cursor: pointer; color: #94a3b8; font-weight: bold; font-size: 18px; padding: 4px 8px; border-radius: 6px;}
        .close-btn:hover { background: #f1f5f9; color: #ef4444; }

        /* INPUTS */
        label { font-size: 11px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: -8px;}
        input, select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-family: 'Inter'; font-size: 14px;}
        .lang-select { width: auto; padding: 4px 8px; font-size: 11px; border-radius: 6px; background: #f1f5f9; border: none; cursor: pointer;}
        
        .primary-btn { 
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white; border: none; padding: 14px; border-radius: 8px; 
            cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }
        .primary-btn:hover { transform: translateY(-1px); }

        /* DOWNLOAD BUTTON */
        #downloadBtn {
            position: absolute; bottom: 30px; right: 30px;
            background: white; color: #334155; padding: 12px 20px; border-radius: 50px;
            font-weight: 600; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000; border: 1px solid #e2e8f0; display: none; cursor: pointer; align-items: center; gap: 8px;
        }

        #openBtn {
            position: absolute; top: 20px; left: 20px;
            background: white; padding: 12px; border-radius: 12px;
            font-weight: 700; font-size: 20px; line-height: 1;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 999; border: 1px solid #e2e8f0;
            cursor: pointer; display: none; 
        }

        .callout {
            background: #eff6ff; border-left: 4px solid #3b82f6;
            padding: 10px; border-radius: 4px; font-size: 12px;
            color: #1e40af; margin-bottom: 5px; display: flex; justify-content: space-between;
        }
        .stop-container { display: none; background: #fff1f2; padding: 10px; border-radius: 8px; border: 1px dashed #f43f5e; }
        .stop-label { font-size: 11px; color: #be123c; font-weight: 700; display: flex; justify-content: space-between; }
        .remove-stop { cursor: pointer; text-decoration: underline; }

        /* AI CARD */
        .ai-card { display: none; margin-top: 5px; background: #f8fafc; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; }
        .ai-title { font-size: 10px; font-weight: 700; color: #64748b; letter-spacing: 0.5px; margin-bottom: 8px; }
        .ai-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .ai-main-temp { font-size: 24px; font-weight: 700; color: #1e293b; }
        .ai-sub-text { font-size: 11px; color: #64748b; }
        .ai-forecast-temp { font-size: 16px; font-weight: 600; color: #64748b; }
        .ai-insight-box { font-size: 12px; line-height: 1.4; color: #334155; padding: 10px; background: white; border-radius: 6px; border-left: 4px solid #cbd5e1; }
        
        .emoji-icon { font-size: 24px; text-align: center; line-height: 1; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .marker-pin { font-size: 30px; text-align: center; filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4)); }
    </style>
</head>
<body>

    <datalist id="sg-locations">
        <option value="Tampines MRT">
        <option value="Tampines Eco Green">
        <option value="Bedok Reservoir">
        <option value="Bedok Mall">
        <option value="Changi Airport">
        <option value="Marina Bay Sands">
        <option value="Gardens by the Bay">
        <option value="East Coast Park">
        <option value="Punggol Waterway">
        <option value="Jurong Lake Gardens">
        <option value="Botanic Gardens">
        <option value="National University of Singapore">
        <option value="Nanyang Technological University">
    </datalist>

    <button id="openBtn" onclick="togglePanel()" title="Open Controls">â˜°</button>

    <div id="panel">
        <div class="header-row">
            <h2 style="margin:0;">ğŸš´ CoolRide <span style="font-size:12px;color:white;background:#22c55e;padding:2px 6px;border-radius:10px;">V9.7</span></h2>
            <div class="header-controls">
                <select class="lang-select" onchange="changeLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ta">à®¤à®®à®¿à®´à¯</option>
                </select>
                <div class="close-btn" onclick="togglePanel()">âœ•</div>
            </div>
        </div>

        <div id="onboarding" class="callout">
            <span data-lang="welcome_msg">ğŸ‘‹ <b>New?</b> Try searching "Bedok Reservoir" to see AI cooling!</span>
            <span style="cursor:pointer;opacity:0.5;margin-left:8px;" onclick="document.getElementById('onboarding').style.display='none'">âœ•</span>
        </div>
        
        <input type="text" id="apiUrl" placeholder="ğŸ”Œ Paste Ngrok URL Here" style="font-family:monospace; font-size:11px; background:#f8fafc;">
        
        <label data-lang="start">ğŸ“ Start Point</label>
        <input type="text" id="start" value="Tampines MRT" list="sg-locations">
        
        <div id="stopBox" class="stop-container">
            <div class="stop-label"><span data-lang="added_stop">ğŸ›‘ ADDED STOP</span> <span class="remove-stop" onclick="removeStop()">âœ• Remove</span></div>
            <input type="text" id="stop" placeholder="Coordinates" readonly style="background:transparent; border:none; font-weight:600; color:#881337;">
            <input type="hidden" id="stopCoords"> 
        </div>

        <label data-lang="dest">ğŸ¯ Destination</label>
        <input type="text" id="end" value="Tampines Eco Green" list="sg-locations">
        
        <label data-lang="time">â° Departure Time</label>
        <input type="time" id="time" value="14:00">
        
        <button id="btn-route" class="primary-btn" onclick="calculateRoute(true)" data-lang="btn_find">ğŸš€ Find Cool Route</button>
        <div id="status" style="text-align:center;font-size:13px;color:#64748b;margin-top:5px;" data-lang="status_ready">Ready to connect...</div>

        <div id="ai-card" class="ai-card">
            <div class="ai-title" data-lang="ai_title">ğŸ¤– AI THERMAL FORECAST</div>
            <div class="ai-stats">
                <div>
                    <div class="ai-main-temp" id="ai-temp">--Â°C</div>
                    <div class="ai-sub-text" data-lang="ai_current">Current Heat Stress</div>
                </div>
                <div style="text-align:right;">
                    <div class="ai-forecast-temp" id="ai-forecast">--Â°C</div>
                    <div class="ai-sub-text" data-lang="ai_predict">Predicted (1h)</div>
                </div>
            </div>
            <div id="shade-badge" style="display:none; background:#dcfce7; color:#166534; padding:5px; font-size:11px; font-weight:700; text-align:center; border-radius:4px; margin-bottom:8px;">
                ğŸ›¡ï¸ +25% More Shade on Cool Route
            </div>
            <div id="ai-insight" class="ai-insight-box">AI analysis will appear here...</div>
        </div>
    </div>

    <button id="downloadBtn" onclick="downloadKml()">
        <span>â¬‡ï¸</span> <span data-lang="btn_download">Download KML</span>
    </button>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.3.1/leaflet-omnivore.min.js'></script>

    <script>
        // --- MAP SETUP WITH LAYERS ---
        var streetLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.'
        });
        
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
        });

        // Initialize with Street Map by default
        var map = L.map('map', {
            zoomControl: false,
            layers: [streetLayer] // Default
        }).setView([1.3521, 103.94], 14);

        // Add Layer Control (Top Right)
        var baseMaps = {
            "Street Map": streetLayer,
            "Satellite": satelliteLayer
        };
        L.control.layers(baseMaps).addTo(map);
        
        var routeLayer = null;
        var markerLayer = L.layerGroup().addTo(map); // Layer for Start/End Markers
        var baseRouteData = null; 
        var lastKmlData = null; 

        function togglePanel() {
            var panel = document.getElementById("panel");
            var openBtn = document.getElementById("openBtn");
            if (panel.style.display === "none") {
                panel.style.display = "flex"; openBtn.style.display = "none";
            } else {
                panel.style.display = "none"; openBtn.style.display = "block";
            }
        }

        const translations = {
            en: {
                start: "ğŸ“ Start Point", dest: "ğŸ¯ Destination", time: "â° Departure Time",
                btn_find: "ğŸš€ Find Cool Route", btn_download: "Download KML",
                status_ready: "Ready to connect...", status_compute: "â³ Connecting to AI Brain...",
                ai_title: "ğŸ¤– AI THERMAL FORECAST", ai_current: "Current Heat Stress", ai_predict: "Predicted (1h)",
                added_stop: "ğŸ›‘ ADDED STOP", welcome_msg: "ğŸ‘‹ <b>New?</b> Try searching 'Bedok Reservoir' to see AI cooling!"
            },
            zh: {
                start: "ğŸ“ èµ·ç‚¹", dest: "ğŸ¯ ç»ˆç‚¹", time: "â° å‡ºå‘æ—¶é—´",
                btn_find: "ğŸš€ å¯»æ‰¾æ¸…å‡‰è·¯çº¿", btn_download: "ä¸‹è½½ KML æ–‡ä»¶",
                status_ready: "å‡†å¤‡è¿æ¥...", status_compute: "â³ æ­£åœ¨è¿æ¥ AI å¤§è„‘...",
                ai_title: "ğŸ¤– AI çƒ­é‡é¢„æµ‹", ai_current: "å½“å‰çƒ­åº”åŠ›", ai_predict: "é¢„æµ‹ (1å°æ—¶å)",
                added_stop: "ğŸ›‘ å·²æ·»åŠ ç«™ç‚¹", welcome_msg: "ğŸ‘‹ <b>CoolRide æ–°æ‰‹?</b> å°è¯•æœç´¢ 'Bedok Reservoir' æŸ¥çœ‹æˆ‘ä»¬çš„æ°´å†· AIï¼"
            },
            ta: {
                start: "ğŸ“ à®¤à¯Šà®Ÿà®•à¯à®•à®ªà¯ à®ªà¯à®³à¯à®³à®¿", dest: "ğŸ¯ à®šà¯‡à®°à¯à®®à®¿à®Ÿà®®à¯", time: "â° à®ªà¯à®±à®ªà¯à®ªà®Ÿà¯à®®à¯ à®¨à¯‡à®°à®®à¯",
                btn_find: "ğŸš€ à®•à¯à®³à®¿à®°à¯à®¨à¯à®¤ à®ªà®¾à®¤à¯ˆà®¯à¯ˆ à®•à®£à¯à®Ÿà¯à®ªà®¿à®Ÿà®¿", btn_download: "KML à®ªà®¤à®¿à®µà®¿à®±à®•à¯à®•à®µà¯à®®à¯",
                status_ready: "à®‡à®£à¯ˆà®•à¯à®•à®¤à¯ à®¤à®¯à®¾à®°à®¾à®• à®‰à®³à¯à®³à®¤à¯...", status_compute: "â³ AI à®‰à®Ÿà®©à¯ à®‡à®£à¯ˆà®•à®¿à®±à®¤à¯...",
                ai_title: "ğŸ¤– AI à®µà¯†à®ªà¯à®ª à®®à¯à®©à¯à®©à®±à®¿à®µà®¿à®ªà¯à®ªà¯", ai_current: "à®¤à®±à¯à®ªà¯‹à®¤à¯ˆà®¯ à®µà¯†à®ªà¯à®ªà®®à¯", ai_predict: "à®•à®£à®¿à®ªà¯à®ªà¯ (1 à®®à®£à®¿)",
                added_stop: "ğŸ›‘ à®¨à®¿à®±à¯à®¤à¯à®¤à®®à¯ à®šà¯‡à®°à¯à®•à¯à®•à®ªà¯à®ªà®Ÿà¯à®Ÿà®¤à¯", welcome_msg: "ğŸ‘‹ <b>CoolRide-à®•à¯à®•à¯ à®ªà¯à®¤à®¿à®¯à®µà®°à®¾?</b> à®à®™à¯à®•à®³à¯ à®¨à¯€à®°à¯-à®•à¯à®³à®¿à®°à¯‚à®Ÿà¯à®Ÿà¯à®®à¯ AI-à® à®•à®¾à®£ 'Bedok Reservoir'-à® à®¤à¯‡à®Ÿà®µà¯à®®à¯!"
            }
        };

        function changeLanguage(lang) {
            document.body.style.fontFamily = lang === 'en' ? "'Inter', sans-serif" : (lang === 'zh' ? "'Noto Sans SC', sans-serif" : "'Noto Sans Tamil', sans-serif");
            document.querySelectorAll('[data-lang]').forEach(el => {
                var key = el.getAttribute('data-lang');
                if (translations[lang][key]) el.innerHTML = translations[lang][key];
            });
        }

        var savedUrl = localStorage.getItem("coolride_api_url");
        if (savedUrl) document.getElementById("apiUrl").value = savedUrl;
        document.getElementById("apiUrl").addEventListener("input", function() {
            localStorage.setItem("coolride_api_url", this.value);
        });

        window.addStop = function(coords, name) {
            document.getElementById("stopBox").style.display = "block";
            document.getElementById("stop").value = name;
            document.getElementById("stopCoords").value = coords;
            calculateRoute(false);
        };

        function removeStop() {
            document.getElementById("stopBox").style.display = "none";
            document.getElementById("stop").value = "";
            document.getElementById("stopCoords").value = "";
            if (baseRouteData) {
                renderResult(baseRouteData);
                document.getElementById("status").innerText = "âœ… Restored Original Route";
            } else {
                calculateRoute(true);
            }
        }

        window.downloadKml = function() {
            if (!lastKmlData) return alert("No route generated yet!");
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/xml;charset=utf-8,' + encodeURIComponent(lastKmlData));
            element.setAttribute('download', "cool_route.kml");
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        };

        async function calculateRoute(isBaseRoute) {
            var url = document.getElementById("apiUrl").value.trim();
            if (url.endsWith('/')) url = url.slice(0, -1);
            if (!url) return alert("âš ï¸ Please paste Server URL!");

            var btn = document.getElementById("btn-route");
            var status = document.getElementById("status");
            var lang = document.querySelector(".lang-select").value;
            
            btn.disabled = true;
            btn.innerText = "Computing...";
            status.innerText = translations[lang].status_compute;
            
            if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
            markerLayer.clearLayers(); // CLEAR OLD MARKERS
            
            document.getElementById("downloadBtn").style.display = "none"; 

            var payload = {
                start: document.getElementById("start").value,
                end: document.getElementById("end").value,
                time: document.getElementById("time").value,
                stop: document.getElementById("stopCoords").value || "" 
            };

            try {
                let response = await fetch(url + "/calculate_route", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "ngrok-skip-browser-warning": "true"
                    },
                    body: JSON.stringify(payload)
                });
                let result = await response.json();

                if (result.status === "success") {
                    if (isBaseRoute) baseRouteData = result;
                    lastKmlData = result.kml_data; 
                    renderResult(result);
                    btn.disabled = false;
                    btn.innerText = translations[lang].btn_find;
                } else { throw new Error(result.message); }
            } catch (error) {
                console.error(error);
                status.innerText = "âŒ " + error.message;
                btn.disabled = false;
                btn.innerText = "Try Again";
            }
        }

        function renderResult(result) {
            if (routeLayer) map.removeLayer(routeLayer);
            markerLayer.clearLayers(); // Ensure clear

            // --- DRAW START/END MARKERS ---
            if (result.meta) {
                if (result.meta.start_point) {
                    L.marker(result.meta.start_point, {
                        icon: L.divIcon({ className: 'marker-pin', html: 'ğŸŸ¢', iconSize: [30, 30], iconAnchor: [15, 15] })
                    }).bindPopup("<b>Start Point</b>").addTo(markerLayer);
                }
                if (result.meta.end_point) {
                    L.marker(result.meta.end_point, {
                        icon: L.divIcon({ className: 'marker-pin', html: 'ğŸ”´', iconSize: [30, 30], iconAnchor: [15, 15] })
                    }).bindPopup("<b>Destination</b>").addTo(markerLayer);
                }
            }

            var kmlBlob = new Blob([result.kml_data], {type: "text/xml"});
            var kmlUrl = URL.createObjectURL(kmlBlob);

            var customStyle = L.geoJson(null, {
                style: function(f) {
                    var name = f.properties.name || "";
                    if (name.includes("Fastest")) return { color: "#ef4444", weight: 6, opacity: 0.8 };
                    if (name.includes("Cool")) return { color: "#22c55e", weight: 7, opacity: 1.0 };
                    return { color: "#3b82f6", weight: 5 };
                },
                pointToLayer: function(feature, latlng) {
                    var name = feature.properties.name || "";
                    var desc = feature.properties.description || "";
                    var text = (name + " " + desc).toLowerCase();
                    var iconHtml = "ğŸ“"; 
                    if (text.includes("ğŸœ") || text.includes("hawker")) iconHtml = "ğŸœ";
                    if (text.includes("ğŸ›’") || text.includes("supermarket")) iconHtml = "ğŸ›’";

                    return L.marker(latlng, {
                        icon: L.divIcon({ className: 'emoji-icon', html: iconHtml, iconSize: [30, 30], iconAnchor: [15, 15] })
                    });
                }
            });

            routeLayer = omnivore.kml(kmlUrl, null, customStyle)
                .on('ready', function() {
                    map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
                    this.eachLayer(function(layer) {
                        if (layer.feature && layer.feature.properties.description) {
                            layer.bindPopup(layer.feature.properties.description);
                        }
                    });

                    if (result.ai_data) {
                        var ai = result.ai_data;
                        document.getElementById("ai-card").style.display = "block";
                        document.getElementById("ai-temp").innerText = ai.current_temp + "Â°C";
                        document.getElementById("ai-forecast").innerText = ai.forecast_temp + "Â°C";
                        document.getElementById("ai-insight").innerHTML = ai.insight; 
                        
                        var borderColor = "#22c55e"; 
                        if (ai.color === "red") borderColor = "#ef4444";
                        if (ai.color === "orange") borderColor = "#f59e0b";
                        document.getElementById("ai-insight").style.borderLeftColor = borderColor;

                        var badge = document.getElementById("shade-badge");
                        if (ai.shade_gain && ai.shade_gain > 5) {
                            badge.style.display = "block";
                            badge.innerText = "ğŸ›¡ï¸ " + ai.shade_gain + "% More Shade on Cool Route";
                        } else {
                            badge.style.display = "none";
                        }
                    }
                    
                    var duration = result.meta ? result.meta.duration : "Cached";
                    document.getElementById("status").innerText = "âœ… Route Loaded (" + duration + ")";
                    document.getElementById("status").style.color = "green";
                    document.getElementById("downloadBtn").style.display = "flex"; 
                })
                .addTo(map);
        }
    </script>
</body>
</html>
